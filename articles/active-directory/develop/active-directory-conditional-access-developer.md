---
title: "Azure Active Directory 조건부 액세스를 위한 개발자 지침 | Microsoft Docs"
description: "Azure AD 조건부 액세스를 위한 개발자 지침 및 시나리오"
services: active-directory
keywords: 
author: danieldobalian
manager: mbaldwin
editor: PatAltimore
ms.author: dadobali
ms.date: 07/19/2017
ms.assetid: 115bdab2-e1fd-4403-ac15-d4195e24ac95
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: b8fac1b258535fd668b45acbe2c1c8580fb8a340
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 08/18/2017
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a><span data-ttu-id="09154-103">Azure Active Directory 조건부 액세스를 위한 개발자 지침</span><span class="sxs-lookup"><span data-stu-id="09154-103">Developer Guidance for Azure Active Directory Conditional Access</span></span>

<span data-ttu-id="09154-104">Azure AD(Active Directory)는 앱과 서비스를 보호하기 위한 여러 가지 방법을 제공합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-104">Azure Active Directory (AD) offers several ways to secure your app and protect a service.</span></span>  <span data-ttu-id="09154-105">이러한 고유한 기능 중 하나가 조건부 액세스입니다.</span><span class="sxs-lookup"><span data-stu-id="09154-105">One of these unique features is conditional access.</span></span>  <span data-ttu-id="09154-106">조건부 액세스를 통해 개발자 및 기업 고객은 다음과 같은 다양한 방법으로 서비스를 보호할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-106">Conditional access enables developers and enterprise customers to protect services in a multitude of ways including:</span></span>

* <span data-ttu-id="09154-107">Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="09154-107">Multi-factor authentication</span></span>
* <span data-ttu-id="09154-108">Intune 등록 장치만 특정 서비스에 액세스할 수 있도록 허용</span><span class="sxs-lookup"><span data-stu-id="09154-108">Allowing only Intune enrolled devices to access specific services</span></span>
* <span data-ttu-id="09154-109">사용자 위치 및 IP 범위 제한</span><span class="sxs-lookup"><span data-stu-id="09154-109">Restricting user locations and IP ranges</span></span>

<span data-ttu-id="09154-110">조건부 액세스의 전체 기능에 자세한 내용은 [Azure 클래식 포털에서 조건부 액세스](../active-directory-conditional-access.md)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-110">For more information on the full capabilities of conditional access, see [Conditional access in the Azure classic portal](../active-directory-conditional-access.md).</span></span> 

<span data-ttu-id="09154-111">이 문서에서는 조건부 액세스가 Azure AD용 앱을 빌드하는 개발자에게 어떤 의미인지 중점적으로 설명합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-111">In this article, we focus on what conditional access means to developers building apps for Azure AD.</span></span>  <span data-ttu-id="09154-112">[단일](active-directory-integrating-applications.md) 및 [다중 테넌트](active-directory-devhowto-multi-tenant-overview.md) 앱과 [일반 인증 패턴](active-directory-authentication-scenarios.md)에 대한 지식이 있다고 가정합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-112">It assumes knowledge of [single](active-directory-integrating-applications.md) and [multi-tenant](active-directory-devhowto-multi-tenant-overview.md) apps and [common authentication patterns](active-directory-authentication-scenarios.md).</span></span>

<span data-ttu-id="09154-113">조건부 액세스 정책이 적용될 수 있고 제어권이 없는 리소스에 액세스할 경우의 영향에 대해 자세히 알아보겠습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-113">We'll dive into the impact of accessing resources you don't have control over that may have conditional access policies applied.</span></span>  <span data-ttu-id="09154-114">또한 On-Behalf-Of 흐름, 웹앱, Microsoft Graph 액세스 및 API 호출에서 조건부 액세스의 영향을 알아봅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-114">Moreover, we explore the implications of conditional access in the on-behalf-of flow, web apps, accessing the Microsoft Graph, and calling APIs.</span></span>

## <a name="how-does-conditional-access-impact-an-app"></a><span data-ttu-id="09154-115">조건부 액세스가 앱에 어떤 영향을 주나요?</span><span class="sxs-lookup"><span data-stu-id="09154-115">How does conditional access impact an app?</span></span>

### <a name="app-topologies-impacted"></a><span data-ttu-id="09154-116">영향을 받는 앱 토폴로지</span><span class="sxs-lookup"><span data-stu-id="09154-116">App topologies impacted</span></span>

<span data-ttu-id="09154-117">대부분의 경우, 조건부 액세스는 앱의 동작을 변경하지 않으며 개발자의 변경이 필요하지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-117">In most common cases, conditional access does not change an app's behavior or requires any changes from the developer.</span></span>  <span data-ttu-id="09154-118">앱에서 서비스에 대한 토큰을 간접적으로나 자동으로 요청하는 특정한 경우에만 앱에서 조건부 액세스 “챌린지”를 처리하기 위해 코드 변경이 필요합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-118">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes to handle conditional access "challenges".</span></span>  <span data-ttu-id="09154-119">이것은 대화형 로그인 요청을 수행하는 것처럼 간단할 수도 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-119">It may be as simple as performing an interactive sign-in request.</span></span> 

<span data-ttu-id="09154-120">특히 다음 시나리오에는 조건부 액세스 “챌린지”를 처리하기 위한 코드가 필요합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-120">Specifically, the following scenarios require code to handle conditional access "challenges":</span></span> 

* <span data-ttu-id="09154-121">Microsoft Graph에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-121">Apps accessing the Microsoft Graph</span></span>
* <span data-ttu-id="09154-122">On-Behalf-Of 흐름을 수행하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-122">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="09154-123">여러 서비스/리소스에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-123">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="09154-124">ADAL.js를 사용하는 단일 페이지 앱</span><span class="sxs-lookup"><span data-stu-id="09154-124">Single page apps using ADAL.js</span></span>

<span data-ttu-id="09154-125">조건부 액세스 정책은 앱뿐만 아니라 사용자 앱이 액세스하는 웹 API에도 적용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-125">Conditional access policies can be applied to the app, but also can be applied to a web API your app accesses.</span></span> <span data-ttu-id="09154-126">조건부 액세스 정책을 구성하는 방법에 대한 자세한 내용은 [Azure Active Directory 조건부 액세스 시작](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules)을 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-126">To learn more about how to configure a conditional access policy, please see [Getting started with Azure Active Directory Conditional Access](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span></span>

<span data-ttu-id="09154-127">시나리오에 따라 기업 고객은 언제든지 조건부 액세스 정책을 적용하고 제거할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-127">Depending on the scenario, an enterprise customer can apply and remove conditional access policies at any time.</span></span>  <span data-ttu-id="09154-128">새 정책이 적용될 때 앱이 계속 작동하도록 하려면 “챌린지” 처리를 구현해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-128">In order for your app to continue functioning when a new policy is applied, you need to implement the "challenge" handling.</span></span> <span data-ttu-id="09154-129">다음 예에서는 챌린지 처리를 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="09154-129">The following examples illustrate challenge handling.</span></span> 

### <a name="conditional-access-examples"></a><span data-ttu-id="09154-130">조건부 액세스 예제</span><span class="sxs-lookup"><span data-stu-id="09154-130">Conditional access examples</span></span>

<span data-ttu-id="09154-131">일부 시나리오에서는 조건부 액세스를 처리하기 위해 코드 변경이 필요하지만 그렇지 않고 그대로 작동하는 시나리오도 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-131">Some scenarios require code changes to handle conditional access whereas others work as is.</span></span>  <span data-ttu-id="09154-132">다음에서 다단계 인증을 수행하기 위해 조건부 액세스를 사용하는 몇 가지 시나리오를 살펴보고 차이를 파악할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-132">Here are a few scenarios using conditional access to do multi-factor authentication that gives some insight into the difference.</span></span>

* <span data-ttu-id="09154-133">단일 테넌트 iOS 앱을 빌드 중이고 조건부 액세스 정책을 적용합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-133">You are building a single-tenant iOS app and apply a conditional access policy.</span></span>  <span data-ttu-id="09154-134">사용자는 앱에 로그인하고 앱은 API에 대한 액세스를 요청하지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-134">The app signs in a user and doesn't request access to an API.</span></span>  <span data-ttu-id="09154-135">사용자가 로그인하면 정책이 자동으로 호출되고 사용자는 MFA(Multi-Factor Authentication)를 수행해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-135">When the user signs in, the policy is automatically invoked and the user needs to perform multi-factor authentication (MFA).</span></span> 
* <span data-ttu-id="09154-136">Microsoft Graph를 사용하여 기타 서비스 중에 Exchange에 액세스하는 다중 테넌트 웹앱을 빌드 중입니다.</span><span class="sxs-lookup"><span data-stu-id="09154-136">You are building a multi-tenant web app that uses the Microsoft Graph to access Exchange, among other services.</span></span>  <span data-ttu-id="09154-137">이 앱을 채택하는 기업 고객은 SharePoint Online에서 정책을 설정합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-137">An enterprise customer who adopts this app sets a policy on SharePoint Online.</span></span>  <span data-ttu-id="09154-138">웹앱이 MS Graph에 대한 토큰을 요청하면 Microsoft Service에 대한 정책이 적용됩니다(특히 그래프를 통해 액세스할 수 있는 서비스).</span><span class="sxs-lookup"><span data-stu-id="09154-138">When the web app requests a token for MS Graph, a policy on any Microsoft Service is applied (specifically services that can be accessed through graph).</span></span>  <span data-ttu-id="09154-139">이 최종 사용자에게 MFA에 대한 메시지가 표시됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-139">This end-user is prompted for MFA.</span></span> <span data-ttu-id="09154-140">이 경우 최종 사용자가 유효한 토큰으로 로그인하고 클레임 “챌린지”가 웹앱에 반환됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-140">In the case, the end-user is signed in with valid tokens, a claims "challenge" is returned to the web app.</span></span>  
* <span data-ttu-id="09154-141">중간 계층 서비스를 사용하여 Microsoft Graph에 액세스하는 원시 앱을 빌드 중입니다.</span><span class="sxs-lookup"><span data-stu-id="09154-141">You are building a native app that uses a middle tier service to access the Microsoft Graph.</span></span>  <span data-ttu-id="09154-142">이 앱을 사용하는 회사의 기업 고객은 Exchange Online에 정책을 적용합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-142">An enterprise customer at the company using this app applies a policy to Exchange Online.</span></span>  <span data-ttu-id="09154-143">최종 사용자가 로그인하면 원시 앱은 중간 계층에 대한 액세스를 요청하고 토큰을 보냅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-143">When an end-user signs in, the native app requests access to the middle tier and sends the token.</span></span>  <span data-ttu-id="09154-144">중간 계층은 On-Behalf-Of 흐름을 수행하여 MS Graph에 대한 액세스를 요청합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-144">The middle tier performs on-behalf-of flow to request access to the MS Graph.</span></span>  <span data-ttu-id="09154-145">이때 클레임 “챌린지”가 중간 계층에 표시됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-145">At this point, a claims "challenge" is presented to the middle tier.</span></span> <span data-ttu-id="09154-146">중간 계층은 챌린지를 원시 앱으로 다시 보내는 데, 앱은 조건부 액세스 정책을 준수해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-146">The middle tier sends the challenge back to the native app, which needs to comply with the conditional access policy.</span></span>

### <a name="complying-with-a-conditional-access-policy"></a><span data-ttu-id="09154-147">조건부 액세스 정책 준수</span><span class="sxs-lookup"><span data-stu-id="09154-147">Complying with a conditional access policy</span></span>

<span data-ttu-id="09154-148">여러 가지 서로 다른 앱 토폴로지에 대해, 세션이 설정될 때 조건부 액세스 정책이 평가됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-148">For several different app topologies, a conditional access policy is evaluated when the session is established.</span></span>  <span data-ttu-id="09154-149">조건부 액세스 정책은 앱 및 서비스 단위로 작동하므로 호출되는 시점은 수행하려는 시나리오에 따라 크게 달라집니다.</span><span class="sxs-lookup"><span data-stu-id="09154-149">As a conditional access policy operates on the granularity of apps and services, the point at which it is invoked depends heavily on the scenario you're trying to accomplish.</span></span>

<span data-ttu-id="09154-150">앱이 조건부 액세스 정책으로 서비스에 대한 액세스를 시도하면 조건부 액세스 챌린지가 발생할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-150">When your app attempts to access a service with a conditional access policy, it may encounter a conditional access challenge.</span></span>  <span data-ttu-id="09154-151">이러한 챌린지는 Azure AD 또는 Microsoft Graph의 응답에 제공되는 `claims` 매개 변수에 인코딩됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-151">This challenge is encoded in the `claims` parameter that comes in a response from Azure AD or the Microsoft Graph.</span></span>  <span data-ttu-id="09154-152">이 챌린지 매개 변수의 예는 다음과 같습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-152">Here's an example of this challenge parameter:</span></span> 

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="09154-153">개발자는 이 챌린지를 가져와 Azure AD에 대한 새 요청에 추가할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-153">Developers can take this challenge and append it onto a new request to Azure AD.</span></span>  <span data-ttu-id="09154-154">이 상태를 전달하면 최종 사용자에게 조건부 액세스 정책을 준수하는 데 필요한 작업을 수행하라는 메시지가 나타납니다.</span><span class="sxs-lookup"><span data-stu-id="09154-154">Passing this state prompts the end-user to perform any action necessary to comply with the conditional access policy.</span></span> <span data-ttu-id="09154-155">다음 시나리오에서 구체적인 오류 정보 및 매개 변수를 추출하는 방법을 설명합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-155">In the following scenarios, specifics of the error and how to extract the parameter are explained.</span></span> 

## <a name="scenarios"></a><span data-ttu-id="09154-156">시나리오</span><span class="sxs-lookup"><span data-stu-id="09154-156">Scenarios</span></span>

### <a name="prerequisites"></a><span data-ttu-id="09154-157">필수 조건</span><span class="sxs-lookup"><span data-stu-id="09154-157">Prerequisites</span></span>

<span data-ttu-id="09154-158">Azure AD 조건부 액세스는 [Azure AD Premium](../active-directory-whatis.md#choose-an-edition)에 포함된 기능입니다.</span><span class="sxs-lookup"><span data-stu-id="09154-158">Azure AD conditional access is a feature included in [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span></span>  <span data-ttu-id="09154-159">[허가되지 않은 사용 현황 보고서](../active-directory-conditional-access-unlicensed-usage-report.md)에서 라이선스 요구 사항에 대해 자세히 알아볼 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-159">You can learn more about licensing requirements in the [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span></span>  <span data-ttu-id="09154-160">개발자는 Azure AD Premium을 포함하는 Enterprise Mobility Suite에 대한 평가판 구독을 포함하는 [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx)에 참여할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-160">Developers can join the [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription to the Enterprise Mobility Suite which includes Azure AD Premium.</span></span>

### <a name="considerations-for-specific-scenarios"></a><span data-ttu-id="09154-161">특정 시나리오에 대한 고려 사항</span><span class="sxs-lookup"><span data-stu-id="09154-161">Considerations for specific scenarios</span></span>

<span data-ttu-id="09154-162">다음 정보는 이러한 조건부 액세스 시나리오에만 적용됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-162">The following information only applies in these conditional access scenarios:</span></span>

* <span data-ttu-id="09154-163">Microsoft Graph에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-163">Apps accessing the Microsoft Graph</span></span>
* <span data-ttu-id="09154-164">On-Behalf-Of 흐름을 수행하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-164">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="09154-165">여러 서비스/리소스에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-165">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="09154-166">ADAL.js를 사용하는 단일 페이지 앱</span><span class="sxs-lookup"><span data-stu-id="09154-166">Single page apps using ADAL.js</span></span>

<span data-ttu-id="09154-167">다음 섹션에서는 보다 복잡한 일반적인 시나리오에 대해 알아봅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-167">In the following sections, we'll get into common scenarios in which are more complex.</span></span>  <span data-ttu-id="09154-168">핵심 작동 원리는 Microsoft Graph를 통해 액세스되지 않는 한, 조건부 액세스 정책이 적용된 서비스에 대해 토큰이 요청될 때 조건부 액세스 정책이 평가된다는 것입니다.</span><span class="sxs-lookup"><span data-stu-id="09154-168">The core operating principle is conditional access policies are evaluated at the time the token is requested for the service that has a conditional access policy applied unless it's being accessed through the Microsoft Graph.</span></span>

### <a name="scenario-app-accessing-the-microsoft-graph"></a><span data-ttu-id="09154-169">시나리오: Microsoft Graph에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-169">Scenario: App accessing the Microsoft Graph</span></span>

<span data-ttu-id="09154-170">이 시나리오에서는 웹앱이 Microsoft Graph에 대한 액세스를 요청하는 경우를 살펴봅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-170">In this scenario, we walk through the case when a web app requests access to the Microsoft Graph.</span></span> <span data-ttu-id="09154-171">이 경우 조건부 액세스 정책은 SharePoint, Exchange 또는 Microsoft Graph를 통해 워크로드로 액세스되는 기타 서비스에 할당할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-171">The conditional access policy in this case could be assigned to SharePoint, Exchange, or some other service that is accessed as a workload through the Microsoft Graph.</span></span>  <span data-ttu-id="09154-172">이 예제에서는 Sharepoint Online에 조건부 액세스 정책이 있다고 가정해 보겠습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span></span>

![Microsoft Graph 흐름 다이어그램에 액세스하는 앱](media/active-directory-conditional-access-developer/app-accessing-microsoft-graph-scenario.png)

<span data-ttu-id="09154-174">앱은 먼저 조건부 액세스가 없는 다운스트림 워크로드에 액세스해야 하는 Microsoft Graph에 대한 권한 부여를 요청합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-174">The app first requests authorization to the Microsoft Graph which requires accessing a downstream workload without conditional access.</span></span>  <span data-ttu-id="09154-175">어떠한 정책도 호출하지 않고 요청이 성공하며 앱은 Microsoft Graph에 대한 토큰을 받습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-175">The request succeeds without invoking any policy and the app receives tokens for Microsoft Graph.</span></span>  <span data-ttu-id="09154-176">이 시점에서 앱은 요청된 끝점에 대한 전달자 요청에 액세스 토큰을 사용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-176">At this point, the app may use the access token in a bearer request for the endpoint requested.</span></span> <span data-ttu-id="09154-177">이제 앱은 Microsoft Graph의 Sharepoint Online 끝점에 액세스해야 합니다(예: `https://graph.microsoft.com/v1.0/me/mySite`).</span><span class="sxs-lookup"><span data-stu-id="09154-177">Now, the app needs to access a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span></span>

<span data-ttu-id="09154-178">앱은 Microsoft Graph에 대한 유효한 토큰을 이미 소유하고 있으므로 새 토큰을 발급하지 않고도 새 요청을 수행할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-178">The app already has a valid token for the Microsoft Graph, so it can perform the new request without being issued a new token.</span></span> <span data-ttu-id="09154-179">이 요청은 실패하고 Microsoft Graph에서 ```WWW-Authenticate``` 챌린지와 함께 HTTP 403 사용할 수 없음 형태로 클레임 챌린지가 발급됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-179">This request fails and a claims challenge is issued from Microsoft Graph in the form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span></span>
<span data-ttu-id="09154-180">응답의 예는 다음과 같습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-180">Here's an example of the response:</span></span> 

```
HTTP 403; Forbidden 
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

<span data-ttu-id="09154-181">클레임 챌린지는 ```WWW-Authenticate``` 헤더 내부에 있으며 구문 분석을 통해 다음 요청에 대한 클레임 매개 변수를 추출할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-181">The claims challenge is inside the ```WWW-Authenticate``` header, which can be parsed to extract the claims parameter for the next request.</span></span>  <span data-ttu-id="09154-182">새 요청에 추가되면, Azure AD는 사용자가 로그인할 때 조건부 액세스 정책을 평가할 것을 알고 있으며 앱은 조건부 액세스 정책을 준수합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-182">Once it's appended to the new request, Azure AD knows to evaluate the conditional access policy when signing in the user and the app is now in compliance with the conditional access policy.</span></span>  <span data-ttu-id="09154-183">Sharepoint Online 끝점에 요청을 반복하면 성공합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-183">Repeating the request to the Sharepoint Online endpoint succeeds.</span></span>

<span data-ttu-id="09154-184">클레임 챌린지를 처리하는 방법을 보여 주는 샘플 코드는 ADAL .NET에 대한 [.NET 데스크톱 샘플 코드](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) 또는 ADAL .NET에 대한 [On-Behalf-Of 샘플 코드](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-184">For code samples that demonstrate how to handle the claims challenge, refer to the [.NET Desktop code sample](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) for ADAL .NET or the [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span></span>

### <a name="scenario-app-performing-the-on-behalf-of-flow"></a><span data-ttu-id="09154-185">시나리오: On-Behalf-Of 흐름을 수행하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-185">Scenario: App performing the on-behalf-of flow</span></span>

<span data-ttu-id="09154-186">이 시나리오에서는 원시 앱이 웹 서비스/API를 호출하는 경우를 연습합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-186">In this scenario, we walk through the case in which a native app calls a web service/API.</span></span>  <span data-ttu-id="09154-187">이 서비스에서는 ["On-Behalf-Of" 흐름](active-directory-authentication-scenarios.md#application-types-and-scenarios)을 차례로 수행하여 다운스트림 서비스를 호출합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-187">In turn, this service does [the "on-behalf-of" flow](active-directory-authentication-scenarios.md#application-types-and-scenarios) to call a downstream service.</span></span>  <span data-ttu-id="09154-188">이 경우, 다운스트림 서비스(Web API 2)에 조건부 액세스 정책을 적용했고 서버/디먼 앱보다는 원시 앱을 사용합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-188">In our case, we've applied our conditional access policy to the downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span></span> 

![On-Behalf-Of 흐름을 수행하는 앱 다이어그램](media/active-directory-conditional-access-developer/app-performing-on-behalf-of-scenario.png)

<span data-ttu-id="09154-190">Web API 1이 항상 다운스트림 API를 호출하는 것은 아니므로 Web API 1에 대한 초기 토큰 요청 시 최종 사용자에게 다단계 인증을 표시하지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-190">The initial token request for Web API 1 does not prompt the end-user for multi-factor authentication as Web API 1 may not always hit the downstream API.</span></span>  <span data-ttu-id="09154-191">Web API 1이 Web API 2에 대해 사용자를 대신하여 토큰 요청을 시도하면 사용자가 다단계 인증으로 로그인하지 않았으므로 요청에 실패합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-191">Once Web API 1 tries to request a token on-behalf-of the user for Web API 2, the request fails since the user has not signed in with multi-factor authentication.</span></span>

<span data-ttu-id="09154-192">Azure AD는 몇 가지 흥미로운 데이터가 포함된 HTTP 응답을 반환합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-192">Azure AD returns an HTTP response with some interesting data:</span></span> 

> [!NOTE]
> <span data-ttu-id="09154-193">이 예에서는 다단계 인증 오류에 대한 설명이지만 조건부 액세스와 관련하여 광범위한 `interaction_required`가 포함될 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-193">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining to conditional access.</span></span>  

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="09154-194">Web API 1에서는 `error=interaction_required` 오류를 catch하고 `claims` 챌린지를 데스크톱 앱에 다시 보냅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-194">In our Web API 1, we catch the error `error=interaction_required`, and send back the `claims` challenge to the desktop app.</span></span>  <span data-ttu-id="09154-195">이 시점에 데스크톱 앱은 `acquireToken()`을 새로 호출하고 `claims` 챌린지를 추가 쿼리 문자열 매개 변수로 추가합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-195">At that point, the desktop app can make a new `acquireToken()` call and append the `claims`challenge as an extra query string parameter.</span></span>  <span data-ttu-id="09154-196">이 새로운 요청은 사용자가 다단계 인증을 수행하도록 요구한 후 이 새로운 토큰을 Web API 1로 다시 보내고 On-Behalf-Of 흐름을 완료합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-196">This new request requires the user to do multi-factor authentication and then send this new token back to Web API 1 and complete the on-behalf-of flow.</span></span>

<span data-ttu-id="09154-197">이 시나리오를 사용해 보려면 [.NET 샘플 코드](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-197">To try out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="09154-198">여기서는 Web API 1에서 네이티브 앱으로 클레임 챌린지를 전달하는 방법과 클라이언트 앱 내부에 새 요청을 생성하는 방법을 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="09154-198">It demonstrates how to pass the claims challenge back from Web API 1 to the native app and construct a new request inside the client app.</span></span> 

### <a name="scenario-app-accessing-multiple-services"></a><span data-ttu-id="09154-199">시나리오: 여러 서비스에 액세스하는 앱</span><span class="sxs-lookup"><span data-stu-id="09154-199">Scenario: App accessing multiple services</span></span>

<span data-ttu-id="09154-200">이 시나리오에서는 웹앱이 조건부 액세스 정책이 할당된 두 서비스에 액세스하는 경우를 살펴봅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-200">In this scenario, we walk through the case in which a web app accesses two services one of which has a conditional access policy assigned.</span></span>  <span data-ttu-id="09154-201">사용자 앱 논리에 따라, 앱에서 두 웹 서비스에 액세스하지 않아도 되는 경로가 존재할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-201">Depending on your app logic, there may exist a path in which your app does not require access to both web services.</span></span>  <span data-ttu-id="09154-202">이 시나리오에서 토큰을 요청하는 순서는 최종 사용자 환경에서 중요한 역할을 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-202">In this scenario, the order in which you request a token plays an important role in the end-user experience.</span></span>

<span data-ttu-id="09154-203">웹 서비스 A와 B가 있고 웹 서비스 B에 조건부 액세스 정책이 적용되었다고 가정해 보겠습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-203">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span></span>  <span data-ttu-id="09154-204">초기 대화형 인증 요청에는 두 서비스에 대한 동의가 필요하지만 모든 경우에 조건부 액세스 정책이 요구되지는 않습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-204">While the initial interactive auth request requires consent for both services, the conditional access policy is not required in all cases.</span></span>  <span data-ttu-id="09154-205">앱에서 웹 서비스 B에 대한 토큰을 요청하는 경우 정책이 호출되고 다음과 같이 웹 서비스 A에 대한 후속 요청도 성공합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-205">If the app requests a token for web service B, then the policy is invoked and subsequent requests for web service A also succeeds as follows.</span></span>

![여러 서비스 흐름에 액세스하는 앱 다이어그램](media/active-directory-conditional-access-developer/app-accessing-multiple-services-scenario.png)

<span data-ttu-id="09154-207">또는 앱이 웹 서비스 A에 대한 토큰을 처음으로 요청하는 경우 최종 사용자는 조건부 액세스 정책을 호출하지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-207">Alternatively, if the app initially requests a token for web service A, the end-user does not invoke the conditional access policy.</span></span>  <span data-ttu-id="09154-208">이렇게 하면 앱 개발자가 최종 사용자 환경을 제어하고 모든 경우에 조건부 액세스 정책이 강제로 호출되는 것을 막을 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-208">This allows the app developer to control the end-user experience and not force the conditional access policy to be invoked in all cases.</span></span> <span data-ttu-id="09154-209">까다로운 경우는 앱이 웹 서비스 B에 대한 토큰을 나중에 요청하는 경우입니다.이때 최종 사용자는 조건부 액세스 정책을 준수해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-209">The tricky case is if the app subsequently requests a token for web service B. At this point, the end-user needs to comply with the conditional access policy.</span></span>  <span data-ttu-id="09154-210">앱에서 `acquireToken`을 시도하면 다음 오류를 생성할 수 있습니다(다음 다이어그램에 설명됨).</span><span class="sxs-lookup"><span data-stu-id="09154-210">When the app tries to `acquireToken`, it may generate the following error (illustrated in the following diagram):</span></span> 

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
``` 

![새 토큰을 요청하는 여러 서비스에 액세스하는 앱](media/active-directory-conditional-access-developer/app-accessing-multiple-services-new-token.png)

<span data-ttu-id="09154-212">앱에서 ADAL 라이브러리를 사용하는 경우 토큰을 획득하지 못하면 항상 대화형으로 다시 시도합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-212">If the app is using the ADAL library, a failure to acquire the token is always retried interactively.</span></span>  <span data-ttu-id="09154-213">이 대화형 요청이 발생하면 최종 사용자는 조건부 액세스를 준수할 수 있는 기회를 얻게 됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-213">When this interactive request occurs, the end-user has the opportunity to comply with the conditional access.</span></span>  <span data-ttu-id="09154-214">요청이 `AcquireTokenSilentAsync` 또는 `PromptBehavior.Never`인 경우를 제외하고 앱은 최종 사용자가 정책을 준수할 수 있는 기회를 제공하기 위해 대화형 ```AcquireToken``` 요청을 수행해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-214">This is true unless the request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case the app needs to perform an interactive ```AcquireToken``` request to give the end use the opportunity to comply with the policy.</span></span> 

### <a name="scenario-single-page-app-spa-using-adaljs"></a><span data-ttu-id="09154-215">시나리오: ADAL.js를 사용하는 SPA(단일 페이지 앱)</span><span class="sxs-lookup"><span data-stu-id="09154-215">Scenario: Single Page App (SPA) using ADAL.js</span></span>

<span data-ttu-id="09154-216">이 시나리오에서는 조건부 액세스 보호된 Web API를 호출하는 데 ADAL.js를 사용하는 SPA(단일 페이지 앱)가 있는 경우를 살펴봅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-216">In this scenario, we walk through the case when we have a single page app (SPA), using ADAL.js to call a conditional access protected web API.</span></span>  <span data-ttu-id="09154-217">간단한 아키텍처이지만 조건부 액세스를 기반으로 개발할 때 고려해야 하는 미묘한 차이가 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-217">This is a simple architecture but has some nuances that need to be taken into account when developing around conditional access.</span></span>

<span data-ttu-id="09154-218">ADAL.js에는 토큰을 얻기 위핸 몇 가지 함수가 있습니다(예: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)` 및 `acquireTokenRedirect(…)`).</span><span class="sxs-lookup"><span data-stu-id="09154-218">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span></span> 

* <span data-ttu-id="09154-219">`login()`은 대화형 로그인 요청을 통해 ID 토큰을 가져오지만 조건부 액세스 보호되는 Web API를 비롯한 모든 서비스에 대한 액세스 토큰을 가져오지는 않습니다</span><span class="sxs-lookup"><span data-stu-id="09154-219">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span></span>  
* <span data-ttu-id="09154-220">그런 다음 `acquireToken(…)`을 사용하여 액세스 토큰을 자동으로 얻을 수 있는데, 이는 어떤 상황에서도 UI가 표시되지 않음을 의미합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-220">`acquireToken(…)` can then be used to silently obtain an access token meaning it does not show UI in any circumstance.</span></span>  
* <span data-ttu-id="09154-221">`acquireTokenPopup(…)` 및 `acquireTokenRedirect(…)`는 리소스에 대한 토큰을 대화형으로 요청하는 데 사용되며 이는 항상 로그인 UI가 표시됨을 의미합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-221">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used to interactively request a token for a resource meaning they always show sign-in UI.</span></span>

<span data-ttu-id="09154-222">앱에서 Web API를 호출하는 데 액세스 토큰이 필요한 경우 `acquireToken(…)`을 시도합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-222">When an app needs an access token to call a Web API, it attempts an `acquireToken(…)`.</span></span>  <span data-ttu-id="09154-223">토큰 세션이 만료되거나 조건부 액세스 정책을 준수해야 하는 경우 *acquireToken* 함수가 실패하며 앱은 `acquireTokenPopup()` 또는 `acquireTokenRedirect()`를 사용합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-223">If the token session is expired or we need to comply with a conditional access policy, then the *acquireToken* function fails and the app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span></span>

![ADAL 흐름을 사용하는 단일 페이지 앱 다이어그램](media/active-directory-conditional-access-developer/spa-using-adal-scenario.png)

<span data-ttu-id="09154-225">이제 조건부 액세스 시나리오에 대한 예를 살펴보겠습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-225">Let's walk through an example with our conditional access scenario.</span></span>  <span data-ttu-id="09154-226">최종 사용자는 방금 사이트에 연결되었고 세션이 없습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-226">The end-user just landed on the site and doesn’t have a session.</span></span>  <span data-ttu-id="09154-227">`login()` 호출을 수행하면 다단계 인증 없이 ID 토큰을 가져옵니다.</span><span class="sxs-lookup"><span data-stu-id="09154-227">We perform a `login()` call, get an ID token without multi-factor authentication.</span></span>  <span data-ttu-id="09154-228">그러면 사용자는 단추를 눌러 앱이 Web API로부터 데이터를 요청하도록 해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-228">Then the user hits a button that requires the app to request data from a web API.</span></span>  <span data-ttu-id="09154-229">앱은 `acquireToken()` 호출을 수행하려고 하지만 사용자가 아직 다단계 인증을 수행하지 않았고 조건부 액세스 정책을 준수해야 하므로 실패합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-229">The app tries to do an `acquireToken()` call but fails since the user has not performed multi-factor authentication yet and needs to comply with the conditional access policy.</span></span>

<span data-ttu-id="09154-230">Azure AD는 다음 HTTP 응답을 다시 보냅니다.</span><span class="sxs-lookup"><span data-stu-id="09154-230">Azure AD sends back the following HTTP response:</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

<span data-ttu-id="09154-231">앱은 `error=interaction_required`를 catch해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-231">Our app needs to catch the `error=interaction_required`.</span></span>  <span data-ttu-id="09154-232">그러면 응용 프로그램은 동일한 리소스에서 `acquireTokenPopup()` 또는 `acquireTokenRedirect()`를 사용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="09154-232">The application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on the same resource.</span></span>  <span data-ttu-id="09154-233">사용자는 다단계 인증을 수행해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-233">The user is forced to do a multi-factor authentication.</span></span> <span data-ttu-id="09154-234">사용자가 다단계 인증을 완료하면 앱에는 요청된 리소스에 대한 새로운 액세스 토큰이 발급됩니다.</span><span class="sxs-lookup"><span data-stu-id="09154-234">After the user completes the multi-factor authentication, the app is issued a fresh access token for the requested resource.</span></span>

<span data-ttu-id="09154-235">이 시나리오를 사용해 보려면 [JS SPA On-behalf-of 샘플 코드](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-235">To try out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="09154-236">이 샘플 코드에서는 이 시나리오를 설명하기 위해 JS SPA와 함께 이전에 등록한 조건부 액세스 정책 및 Web API를 사용합니다.</span><span class="sxs-lookup"><span data-stu-id="09154-236">This code sample uses the conditional access policy and web API you registered earlier with a JS SPA to demonstrate this scenario.</span></span> <span data-ttu-id="09154-237">클레임 챌린지를 올바르게 처리하고 Web API에 사용할 수 있는 액세스 토큰을 가져오는 방법을 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="09154-237">It shows how to properly handle the claims challenge and get an access token that can be used for your Web API.</span></span> <span data-ttu-id="09154-238">또한 Angular SPA에 대한 지침은 일반 [Angular.js 샘플 코드](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp)를 확인하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-238">Alternatively, checkout the general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span></span>


## <a name="see-also"></a><span data-ttu-id="09154-239">참고 항목</span><span class="sxs-lookup"><span data-stu-id="09154-239">See also</span></span>

* <span data-ttu-id="09154-240">기능에 대해 자세히 알아보려면 [Azure AD의 조건부 액세스](../active-directory-conditional-access.md)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-240">To learn more about the capabilities, see [Conditional Access in Azure AD](../active-directory-conditional-access.md).</span></span>
* <span data-ttu-id="09154-241">더 많은 Azure AD 샘플 코드를 보려면 [샘플의 Github 리포지토리](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-241">For more Azure AD code samples, see [Github Repo of Code Samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span></span> 
* <span data-ttu-id="09154-242">ADAL SDK에 대한 자세한 내용을 보고 참조 설명서에 액세스하려면 [라이브러리 가이드](active-directory-authentication-libraries.md)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-242">For more info on the ADAL SDK's and access the reference documentation, see [library guide](active-directory-authentication-libraries.md).</span></span>
* <span data-ttu-id="09154-243">다중 테넌트 시나리오에 대한 자세한 내용은 [다중 테넌트 패턴을 사용하여 사용자를 로그인하는 방법](active-directory-devhowto-multi-tenant-overview.md)을 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="09154-243">To learn more about multi-tenant scenarios, see [How to sign in users using the multi-tenant pattern](active-directory-devhowto-multi-tenant-overview.md).</span></span>
