---
title: "Kerberos 제한 위임을 사용하도록 응용 프로그램 프록시 응용 프로그램을 구성하는 방법 | Microsoft 문서"
description: "Azure AD 응용 프로그램 프록시 응용 프로그램에 대한 Kerberos 제한 위임을 구성하는 방법"
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="34c3a-103">Kerberos 제한 위임을 사용하도록 응용 프로그램 프록시 응용 프로그램을 구성하는 방법</span><span class="sxs-lookup"><span data-stu-id="34c3a-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="34c3a-104">게시된 응용 프로그램에 SSO를 적용하는 데 사용할 수 있는 방법은 응용 프로그램마다 약간 다를 수 있으며 Azure 응용 프로그램 프록시가 즉시 사용할 수 있는 옵션 중 하나는 KCD(Kerberos 제한 위임)입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="34c3a-105">여기서 커넥터 호스트는 사용자 대신 백 엔드 응용 프로그램에 대해 제한된 Kerberos 인증을 수행하도록 구성됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="34c3a-106">KCD를 사용하기 위한 실제 절차는 비교적 간단하며 일반적으로 SSO를 용이하게 하는 다양한 구성 요소와 인증 흐름을 이해하고 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="34c3a-107">KCD SSO가 예상대로 작동하지 않는 시나리오의 문제를 해결하기 위한 유용한 정보 소스를 찾는 방법은 어려울 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="34c3a-108">따라서 이 문서에서는 가장 일반적인 문제 중 일부를 해결하고 자체 수정하는 데 도움이 되는 단일 참조 지점을 제공하려고 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="34c3a-109">동시에 보다 복잡하고 문제가 있는 구현을 진단하기 위한 추가 지침을 제공합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="34c3a-110">이 문서에서는 다음과 같이 가정합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="34c3a-111">Azure 응용 프로그램 프록시가 [설명서](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable)에 따라 배포되었으며 비 KCD 응용 프로그램에 대한 일반적인 액세스가 예상대로 작동합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="34c3a-112">게시된 대상 응용 프로그램은 IIS 및 Microsoft의 kerberos 구현을 기반으로 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="34c3a-113">서버 및 응용 프로그램 호스트는 단일 Active Directory 도메인에 상주합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="34c3a-114">크로스 도메인 및 포리스트 시나리오에 대한 자세한 내용은 [KCD 백서](http://aka.ms/KCDPaper)에서 확인할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="34c3a-115">주체 응용 프로그램은 사전 인증을 사용하는 Azure 테넌트에 게시되며 사용자는 양식 기반 인증을 통해 Azure에 인증해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="34c3a-116">리치 클라이언트 인증 시나리오는 이 문서에서 다루지 않지만 향후 추가될 예정입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="34c3a-117">필수 조건</span><span class="sxs-lookup"><span data-stu-id="34c3a-117">Prerequisites</span></span>

<span data-ttu-id="34c3a-118">Azure 응용 프로그램 프록시는 거의 모든 유형의 인프라 또는 환경에 배포할 수 있으며 아키텍처는 조직마다 다를 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="34c3a-119">KCD 관련 문제의 가장 일반적인 원인 중 하나는 환경 자체가 아니라 단순한 잘못된 구성 또는 일반적인 감독입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="34c3a-120">따라서 문제 해결을 시작하기 전에 주 [KCD SSO를 응용 프로그램 프록시와 함께 사용 문서](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)에 있는 모든 필수 조건을 충족하는지 항상 확인하는 것이 좋습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="34c3a-121">특히 이전 버전의 Windows에서 KCD를 구성할 때는 근본적으로 다른 접근 방식을 사용하기 때문에 2012R2에서 KCD를 구성하는 섹션뿐 아니라 다음과 같은 여러 가지 고려 사항을 염두에 두어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="34c3a-122">도메인 구성원 서버가 특정 도메인 컨트롤러가 있는 보안 채널 대화 상자를 여는 것은 흔한 일입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="34c3a-123">그런 다음 언제든지 다른 대화 상자로 이동되므로 일반적으로 커넥터 호스트를 특정 로컬 사이트 DC와만 통신할 수 있도록 제한해서는 안 됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="34c3a-124">위와 마찬가지로 크로스 도메인 시나리오는 커넥터 호스트를 로컬 네트워크 경계 외부에 있는 DC로 연결하는 참조를 사용합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="34c3a-125">이 시나리오에서는 다른 각 도메인을 나타내는 DC에 트래픽을 허용하거나 위임이 실패하는지 확인하는 것도 중요합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="34c3a-126">가능한 경우에는 커넥터 호스트와 DC 사이에 활성 IPS/IDS 장치를 배치해서는 안 됩니다. 이러한 장치가 코어 RPC 트래픽을 방해할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="34c3a-127">신속하고 효과적으로 문제를 해결하는 데 많은 시간이 걸릴 수 있으므로 가능한 경우 가장 간단한 시나리오에서 위임을 시도하고 테스트해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="34c3a-128">변수가 많을수록 더 많이 고민해야 할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="34c3a-129">예를 들어 테스트를 단일 커넥터로 제한하면 귀중한 시간을 절약할 수 있으며 문제가 해결된 후에 다른 커넥터를 추가할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="34c3a-130">일부 환경 요인도 문제에 영향을 줄 수 있으므로 가능한 경우 테스트를 위한 아키텍처를 최소화합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="34c3a-131">예를 들어 내부 방화벽 ACL이 잘못 구성되는 것은 드문 일이 아니므로 가능하면 커넥터의 모든 트래픽이 DC 및 백 엔드 응용 프로그램을 통해 직접 허용될 수 있도록 설정합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="34c3a-132">실제로 커넥터를 배치하는 가장 좋은 장소는 가능한 한 대상과 가까운 위치입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="34c3a-133">테스트가 진행되는 동안 방화벽을 인라인으로 배치하면 쓸데없이 복잡해져 검사가 지연될 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="34c3a-134">KCD 문제가 되는 요소는 무엇인가요?</span><span class="sxs-lookup"><span data-stu-id="34c3a-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="34c3a-135">KCD SSO 문제를 나타내는 몇 가지 일반적인 징후가 있으며 문제의 첫 번째 징후는 일반적으로 브라우저에서 나타납니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![잘못된 KCD 구성 오류](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![누락된 권한으로 인해 권한 부여 실패](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="34c3a-138">모두 SSO를 수행하지 못하는 동일한 증상을 나타내며 결과적으로 응용 프로그램에 대한 사용자 액세스가 거부됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="34c3a-139">문제 해결</span><span class="sxs-lookup"><span data-stu-id="34c3a-139">Troubleshooting</span></span>

<span data-ttu-id="34c3a-140">문제를 해결하는 방법은 문제와 관찰된 증상에 따라 달라집니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="34c3a-141">계속 진행하기 전에 유용한 정보가 설명되어 있는 다음 링크를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="34c3a-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="34c3a-142">응용 프로그램 프록시 문제 및 오류 메시지 문제 해결</span><span class="sxs-lookup"><span data-stu-id="34c3a-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="34c3a-143">Kerberos 오류 및 증상</span><span class="sxs-lookup"><span data-stu-id="34c3a-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="34c3a-144">온-프레미스 및 클라우드 ID가 동일하지 않은 경우 SSO를 사용하여 작업</span><span class="sxs-lookup"><span data-stu-id="34c3a-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="34c3a-145">여기까지 읽어 보면 주요 문제를 찾을 수 있을 것입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="34c3a-146">심층적으로 분석해야 하므로 문제 해결이 가능하도록 흐름을 세 단계로 구분합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="34c3a-147">**클라이언트 사전 인증** - 외부 사용자가 브라우저를 통해 Azure에 대해 인증합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="34c3a-148">KCD SSO가 작동하려면 Azure에 사전 인증할 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="34c3a-149">문제가 있는 경우 먼저 테스트하고 해결해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="34c3a-150">사전 인증 단계는 KCD 또는 게시된 응용 프로그램과 관련이 없습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="34c3a-151">Azure에 존재하는 주체 계정의 온전성과 비활성/차단되지 않았는지 검사하여 불일치를 수정하는 것은 매우 쉽습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="34c3a-152">브라우저의 오류 응답은 대개 원인을 이해하기에 충분합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="34c3a-153">확실하지 않은 경우 다른 문제 해결 문서를 확인할 수도 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="34c3a-154">**위임 서비스** - Azure 프록시 커넥터는 사용자를 대신하여 KDC(Kerberos Distribution Center)에서 Kerberos 서비스 티켓을 얻습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="34c3a-155">클라이언트와 Azure 프론트 엔드 간의 외부 통신은 작동하는지 확인하는 것 이외에는 KCD에 아무런 영향을 미치지 않아야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="34c3a-156">이는 Kerberos 티켓을 얻는 데 사용되는 유효한 사용자 ID로 Azure 프록시 서비스를 제공할 수 있기 때문입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="34c3a-157">이 KCD가 없으면 불가능하며 실패할 것입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="34c3a-158">앞에서 언급했듯이 브라우저 오류 메시지는 일반적으로 실패하는 이유에 대한 단서를 제공합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="34c3a-159">Azure 프록시 이벤트 로그의 실제 이벤트와 동작을 연관시킬 수 있도록 응답의 작업 ID와 타임스탬프를 적어둡니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![잘못된 KCD 구성 오류](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="34c3a-161">이벤트 로그에 표시된 해당 항목은 이벤트 13019 또는 12027로 표시됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="34c3a-162">커넥터 이벤트 로그는 **응용 프로그램 및 서비스 로그** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**에서 찾을 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![응용 프로그램 프록시 이벤트 로그의 이벤트 13019](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![응용 프로그램 프록시 이벤트 로그의 이벤트 12027](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="34c3a-165">응용 프로그램의 주소에 대해 내부 DNS의 A 레코드를 사용하고 CName은 사용하지 마세요.</span><span class="sxs-lookup"><span data-stu-id="34c3a-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="34c3a-166">커넥터 호스트에 지정된 대상 계정의 SPN에 위임할 수 있는 권한이 부여되었으며 **모든 인증 프로토콜 사용**이 선택되었는지 다시 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="34c3a-167">자세한 내용은 주 [SSO 구성 문서](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)에서 다룹니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="34c3a-168">도메인 구성원 호스트의 명령 프롬프트에서 **setspn-x**를 실행하여 AD에 SPN 인스턴스가 하나만 존재하는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="34c3a-169">도메인 정책에서 [발행된 kerberos 토큰의 최대 크기](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/)를 제한하는지 확인합니다. 이렇게 하면 토큰 크기가 최대 크기를 초과하는 경우 커넥터에서 토큰을 가져올 수 없습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="34c3a-170">문제에 대해 보다 세부적인 정보를 얻기 위한 차선책은 커넥터 호스트와 도메인 KDC 간의 교환을 캡처하는 네트워크 추적입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="34c3a-171">자세한 내용은 [심층 분석 문제 해결 문서](https://aka.ms/proxytshootpaper)를 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="34c3a-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="34c3a-172">티켓팅이 잘되면 응용 프로그램이 401을 반환하여 인증에 실패했음을 알리는 이벤트가 로그에 표시되어 있을 것입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="34c3a-173">이는 일반적으로 대상 응용 프로그램이 티켓을 거부했음을 나타내므로 다음 단계를 진행합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="34c3a-174">**대상 응용 프로그램** - 커넥터가 제공한 Kerberos 티켓의 소비자</span><span class="sxs-lookup"><span data-stu-id="34c3a-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="34c3a-175">이 단계에서 커넥터는 Kerberos 서비스 티켓을 첫 번째 응용 프로그램 요청의 헤더인 백 엔드에 보내야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="34c3a-176">포털에 정의된 응용 프로그램의 내부 URL을 사용하여 커넥터 호스트의 브라우저에서 응용 프로그램에 직접 액세스할 수 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="34c3a-177">그런 다음 성공적으로 로그인할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-177">Then you can login successfully.</span></span> <span data-ttu-id="34c3a-178">이 작업에 대한 자세한 내용은 커넥터 문제 해결 페이지에서 확인할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="34c3a-179">커넥터 호스트에서 다음 중 하나를 수행하여 브라우저와 응용 프로그램 사이의 인증이 kerberos를 사용하는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="34c3a-180">Internet Explorer에서 Dev 도구(**F12**)를 실행하거나 커넥터 호스트에서 [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/)를 사용합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="34c3a-181">내부 URL을 사용하여 응용 프로그램으로 이동한 다음 응용 프로그램의 응답에 반환된 WWW 인증 헤더를 검사하여 협상 또는 Kerberos가 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="34c3a-182">브라우저에서 응용 프로그램으로의 응답에 포함된 후속 kerberos Blob은 일반적으로 **YII**로 시작하므로 이를 통해 Kerberos가 작동 중임을 알 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="34c3a-183">반면에 NTLM은 항상 **TlRMTVNTUAAB**로 시작합니다. 이는 Base64에서 디코딩되면 NTLMSSP가 됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="34c3a-184">Blob 시작 부분에 **TlRMTVNTUAAB**가 표시되면 이는 Kerberos를 **사용할 수 없다**는 의미입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="34c3a-185">TlRMTVNTUAAB가 표시되지 않으면 Kerberos를 사용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="34c3a-186">참고로 Fiddler를 사용하는 경우 이 방법을 사용하려면 IIS에서 응용 프로그램의 구성에 대한 확장된 보호를 일시적으로 해제해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![브라우저 네트워크 검사 창](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="34c3a-188">*그림:* TIRMTVNTUAAB로 시작하지 않기 때문에 Kerberos를 사용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="34c3a-189">이는 YII로 시작하지 않는 Kerberos Blob의 예입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="34c3a-190">일시적으로 IIS 사이트의 공급자 목록에서 NTLM을 제거하고 커넥터 호스트의 IE에서 직접 앱에 액세스합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="34c3a-191">NTLM이 더 이상 공급자 목록에 없으면 Kerberos만 사용하여 응용 프로그램에 액세스할 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="34c3a-192">실패하면 응용 프로그램의 구성에 문제가 있음을 나타내며 Kerberos 인증이 작동하지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="34c3a-193">Kerberos를 사용할 수 없는 경우 IIS에서 응용 프로그램의 인증 설정을 확인하여 Negotiate가 최상위에 나열되고 NTLM이 바로 아래에 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="34c3a-194">(Negotiate:kerberos 또는 Negotiate:PKU2U 아님).</span><span class="sxs-lookup"><span data-stu-id="34c3a-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="34c3a-195">Kerberos가 작동하는 경우에만 계속 진행합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-195">Only continue if Kerberos is functional.</span></span>

   ![Windows 인증 공급자](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="34c3a-197">Kerberos 및 NTLM을 사용하면 포털에서 응용 프로그램의 사전 인증을 일시적으로 비활성화할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="34c3a-198">외부 URL을 사용하여 인터넷에서 액세스할 수 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="34c3a-199">이전 단계에서 사용한 동일한 계정으로 인증하라는 메시지가 나타나야 합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="34c3a-200">그렇지 않은 경우 백 엔드 응용 프로그램에 문제가 있으며 KCD가 아니라는 것을 나타냅니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="34c3a-201">이제 포털에서 사전 인증을 다시 활성화하고 외부 URL을 통해 응용 프로그램에 연결을 시도하여 Azure를 통해 인증합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="34c3a-202">SSO가 실패하면 브라우저에 사용할 수 없음 오류 메시지와 함께 로그에 이벤트 13022가 표시됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="34c3a-203">*백 엔드 서버가 HTTP 401 오류와 함께 Kerberos 인증 시도에 응답하기 때문에 Microsoft AAD Application Proxy Connector에서 사용자를 인증할 수 없습니다.*</span><span class="sxs-lookup"><span data-stu-id="34c3a-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![HTTTP 401 사용할 수 없음 오류](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="34c3a-205">아래 그림과 같이 IIS를 탐색하여 AD에서 SPN이 구성된 것과 동일한 계정을 사용하도록 구성된 응용 프로그램 풀이 구성되어 있는지 확인하려면 IIS 응용 프로그램을 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![IIS 응용 프로그램 구성 창](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="34c3a-207">ID를 알고 있으면 명령 프롬프트에서 다음을 실행하여 이 계정이 해당 SPN으로 구성되어 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="34c3a-208">예를 들어 **setspn – q http/spn.wacketywack.com**을 실행합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![SetSPN 명령 창](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="34c3a-210">포털에서 응용 프로그램의 설정에 정의된 SPN이 응용 프로그램의 응용 프로그램 풀에서 사용 중인 대상 AD 계정에 대해 구성된 것과 동일한 SPN인지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Azure Portal의 SPN 구성](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="34c3a-212">IIS로 이동하여 응용 프로그램에 대한 **구성 편집기** 옵션을 선택하고 **system.webServer/security/authentication/windowsAuthentication**으로 이동하여 **UseAppPoolCredentials**가 true로 설정되어 있는지 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![IIS 구성 앱 풀 자격 증명 옵션](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="34c3a-214">커널 모드를 사용하면 Kerberos 작업의 성능을 향상시킬 수 있지만 요청한 서비스의 티켓이 컴퓨터 계정을 사용하여 해독됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="34c3a-215">이를 로컬 시스템이라고도 합니다. 따라서 이 설정을 true로 설정하면 팜의 여러 서버에서 응용 프로그램을 호스트할 때 KCD가 손상됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="34c3a-216">추가 검사 때문에 **확장** 보호를 해제할 수도 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="34c3a-217">응용 프로그램이 기본 웹 사이트의 하위 폴더로 게시되는 매우 특정한 구성에서 이 기능을 사용하도록 설정한 경우 KCD를 손상시키는 것으로 판명된 시나리오가 있었습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="34c3a-218">이 자체는 익명 인증용으로만 구성되며 전체 대화 상자가 회색으로 표시되어 자식 개체가 활성 설정을 상속받지 않음을 나타냅니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="34c3a-219">그러나 가능한 경우 항상 이 기능을 사용하도록 설정하는 것이 좋습니다. 따라서 테스트 후 복원하는 것을 잊지 마세요.</span><span class="sxs-lookup"><span data-stu-id="34c3a-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="34c3a-220">이러한 추가 검사를 통해 게시된 응용 프로그램 사용 시작을 추적할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="34c3a-221">위임하도록 구성된 다른 커넥터를 계속 스핀업할 수 있지만 더 이상 없으면 심층 기술 연습 [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)(Azure AD 응용 프로그램 프록시 문제 해결에 대한 완벽한 가이드)를 읽어 보는 것이 좋습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="34c3a-222">그래도 문제를 해결할 수 없는 경우 여기를 통해 지원팀에 문의해 주세요.</span><span class="sxs-lookup"><span data-stu-id="34c3a-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="34c3a-223">포털에서 직접 지원 티켓을 작성하면 엔지니어가 연락을 드릴 것입니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="34c3a-224">기타 시나리오</span><span class="sxs-lookup"><span data-stu-id="34c3a-224">Other scenarios</span></span>

-   <span data-ttu-id="34c3a-225">Azure 응용 프로그램 프록시는 응용 프로그램에 요청을 보내기 전에 Kerberos 티켓을 요청합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="34c3a-226">Tableau Server와 같은 일부 타사 응용 프로그램은 이 인증 방법 대신 더 기본적인 협상이 이루어지는 것을 기대합니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="34c3a-227">첫 번째 요청은 익명으로 처리되므로 응용 프로그램이 401을 통해 지원하는 인증 유형으로 응답할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="34c3a-228">이중 홉 인증 - 일반적으로 SQL Reporting Services와 같이 인증이 필요한 백 엔드 및 프런트 엔드를 사용하여 응용 프로그램이 계층화된 시나리오에 사용됩니다.</span><span class="sxs-lookup"><span data-stu-id="34c3a-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="34c3a-229">다음 단계</span><span class="sxs-lookup"><span data-stu-id="34c3a-229">Next steps</span></span>
[<span data-ttu-id="34c3a-230">관리되는 도메인에서 KCD(Kerberos 제한 위임) 구성</span><span class="sxs-lookup"><span data-stu-id="34c3a-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
