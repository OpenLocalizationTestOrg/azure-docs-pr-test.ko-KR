---
title: "2계층 응용 프로그램을 사용한 하이브리드 연결 | Microsoft Docs"
description: "Azure에서 다중 계층 응용 프로그램 환경을 만드는 UDR 및 가상 어플라이언스를 배포하는 방법에 대해 알아봅니다."
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="3d0be-103">가상 어플라이언스 시나리오</span><span class="sxs-lookup"><span data-stu-id="3d0be-103">Virtual appliance scenario</span></span>
<span data-ttu-id="3d0be-104">대규모 Azure 고객 간에 일반적인 시나리오는 온-프레미스 데이터 센터에서 후면 계층에 액세스를 허용하는 동안 인터넷에 노출된 2계층 응용 프로그램을 제공해야 하는 경우입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="3d0be-105">이 문서에서는 UDR(사용자 정의 경로), VPN 게이트웨이 및 네트워크 가상 어플라이언스를 사용하여 다음 요구 사항을 충족하는 2계층 환경을 배포하는 시나리오를 설명합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="3d0be-106">웹 응용 프로그램은 공용 인터넷에서만 액세스할 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="3d0be-107">응용 프로그램을 호스트하는 웹 서버는 백 엔드 응용 프로그램 서버에 액세스할 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="3d0be-108">인터넷에서 웹 응용 프로그램으로 이동하는 모든 트래픽은 방화벽 가상 어플라이언스를 통해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3d0be-109">이 가상 어플라이언스는 인터넷 트래픽에 대해서만 사용됩니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="3d0be-110">응용 프로그램 서버로 이동하는 모든 트래픽은 방화벽 가상 어플라이언스를 통해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3d0be-111">이 가상 어플라이언스는 백 엔드 서버에 대한 액세스 및 VPN 게이트웨이를 통해 온-프레미스 네트워크에서 들어오는 액세스에 사용됩니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="3d0be-112">관리자는 관리 목적으로 독점적으로 사용된 세 번째 방화벽 가상 어플라이언스를 사용하여 온-프레미스 컴퓨터에서 방화벽 가상 어플라이언스를 관리할 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="3d0be-113">이는 DMZ 및 보호된 네트워크를 사용한 표준 DMZ 시나리오입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="3d0be-114">NSG, 방화벽 가상 어플라이언스 또는 둘의 조합을 사용하여 Azure에서 이러한 시나리오를 생성할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="3d0be-115">아래 표에서는 NSG와 방화벽 가상 어플라이언스 간의 장단점 중 일부를 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="3d0be-116">장점</span><span class="sxs-lookup"><span data-stu-id="3d0be-116">Pros</span></span> | <span data-ttu-id="3d0be-117">단점</span><span class="sxs-lookup"><span data-stu-id="3d0be-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-118">NSG</span><span class="sxs-lookup"><span data-stu-id="3d0be-118">NSG</span></span> |<span data-ttu-id="3d0be-119">무료입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-119">No cost.</span></span> <br/><span data-ttu-id="3d0be-120">Azure RBAC에 통합됩니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="3d0be-121">ARM 템플릿에서 규칙을 만들 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="3d0be-122">대규모 환경에서 복잡성이 달라질 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="3d0be-123">방화벽</span><span class="sxs-lookup"><span data-stu-id="3d0be-123">Firewall</span></span> |<span data-ttu-id="3d0be-124">데이터 평면을 완벽히 제어합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-124">Full control over data plane.</span></span> <br/><span data-ttu-id="3d0be-125">방화벽 콘솔을 통해 중앙에서 관리합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-125">Central management through firewall console.</span></span> |<span data-ttu-id="3d0be-126">방화벽 어플라이언스의 비용이 듭니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="3d0be-127">Azure RBAC와 통합되지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="3d0be-128">아래 솔루션은 방화벽 가상 어플라이언스를 사용하여 DMZ/보호된 네트워크 시나리오를 구현합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="3d0be-129">고려 사항</span><span class="sxs-lookup"><span data-stu-id="3d0be-129">Considerations</span></span>
<span data-ttu-id="3d0be-130">다음과 같이 현재 사용할 수 있는 다양한 기능을 사용하여 Azure에서 위에 설명된 환경을 배포할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="3d0be-131">**가상 네트워크(VNet)**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="3d0be-132">Azure VNet은 온-프레미스 네트워크에 비슷한 방식으로 작동하며 문제 분리 및 트래픽 격리를 제공하기 위해 하나 이상의 서브넷으로 분할할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="3d0be-133">**가상 어플라이언스**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-133">**Virtual appliance**.</span></span> <span data-ttu-id="3d0be-134">여러 파트너가 위에 설명된 세 개의 방화벽에 대해 사용할 수 있는 가상 어플라이언스를 Azure 마켓플레이스에서 제공합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="3d0be-135">**UDR(사용자 정의 경로)**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="3d0be-136">경로 테이블에는 Azure 네트워킹이 VNet 내에서 패킷 흐름을 제어하는 데 사용하는 UDR이 포함될 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="3d0be-137">이러한 경로 테이블을 서브넷에 적용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="3d0be-138">Azure의 최신 기능 중 하나는 Azure VNet에 들어오는 모든 트래픽을 하이브리드 연결에서 가상 어플라이언스로 전달하는 기능을 제공하는 GatewaySubnet에 경로 테이블을 적용하는 기능입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="3d0be-139">**IP 전달**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-139">**IP Forwarding**.</span></span> <span data-ttu-id="3d0be-140">기본적으로 Azure 네트워킹 엔진은 패킷 대상 IP 주소가 NIC IP 주소와 일치하는 경우에만 가상 NIC(네트워크 인터페이스 카드)에 패킷을 전달합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="3d0be-141">따라서 UDR이 지정된 가상 어플라이언스로 패킷을 보내야 한다고 정의하는 경우 Azure 네트워킹 엔진이 해당 패킷을 삭제합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="3d0be-142">패킷의 실제 대상이 아닌 VM(이 경우 가상 어플라이언스)에 패킷이 전달되도록 하려면 가상 어플라이언스에 대해 IP 전달을 사용하도록 설정해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="3d0be-143">**NSG(네트워크 보안 그룹)**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="3d0be-144">아래 예제에서는 NSG를 사용하지 않지만 이 솔루션의 서브넷 및/또는 NIC에 적용된 NSG를 사용하여 해당 서브넷 및 NIC의 내외부 트래픽을 추가로 필터링할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![IPv6 연결](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="3d0be-146">이 예에서는 다음을 포함하는 구독이 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="3d0be-147">다이어그램에 표시되지 않은 2개의 리소스 그룹</span><span class="sxs-lookup"><span data-stu-id="3d0be-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="3d0be-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-148">**ONPREMRG**.</span></span> <span data-ttu-id="3d0be-149">온-프레미스 네트워크를 시뮬레이트하는 데 필요한 모든 리소스를 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="3d0be-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-150">**AZURERG**.</span></span> <span data-ttu-id="3d0be-151">Azure 가상 네트워크 환경에 필요한 모든 리소스를 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="3d0be-152">아래 나열된 대로 분할된 온-프레미스 데이터 센터를 가장하는 데 사용되는 **onpremvnet** 이라는 VNet</span><span class="sxs-lookup"><span data-stu-id="3d0be-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="3d0be-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-153">**onpremsn1**.</span></span> <span data-ttu-id="3d0be-154">온-프레미스 서버를 가장하는 Ubuntu를 실행하는 VM(가상 컴퓨터)이 포함된 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="3d0be-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-155">**onpremsn2**.</span></span> <span data-ttu-id="3d0be-156">관리자가 사용하는 온-프레미스 컴퓨터를 가장하는 Ubuntu를 실행하는 VM이 포함된 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="3d0be-157">**azurevnet**에 터널을 유지 관리하는 데 사용되는 **onpremvnet**에 **OPFW**라는 하나의 방화벽 가상 어플라이언스</span><span class="sxs-lookup"><span data-stu-id="3d0be-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="3d0be-158">아래 나열된 대로 분할된 **azurevnet** 이라는 VNet</span><span class="sxs-lookup"><span data-stu-id="3d0be-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="3d0be-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-159">**azsn1**.</span></span> <span data-ttu-id="3d0be-160">외부 방화벽에 독점적으로 사용되는 외부 방화벽 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="3d0be-161">모든 인터넷 트래픽이 이 서브넷을 통해 들어옵니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="3d0be-162">이 서브넷은 외부 방화벽에 연결된 NIC만 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="3d0be-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-163">**azsn2**.</span></span> <span data-ttu-id="3d0be-164">인터넷에서 액세스할 수 있는 웹 서버로 실행되는 VM을 호스트하는 프런트 엔드 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="3d0be-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-165">**azsn3**.</span></span> <span data-ttu-id="3d0be-166">프런트 엔드 웹 서버에서 액세스할 수 있는 백 엔드 응용 프로그램 서버를 실행하는 VM을 호스트하는 백 엔드 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="3d0be-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-167">**azsn4**.</span></span> <span data-ttu-id="3d0be-168">모든 방화벽 가상 어플라이언스에 대한 관리 액세스를 제공하는 데 독점적으로 사용되는 관리 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="3d0be-169">이 서브넷은 솔루션에서 사용하는 각 방화벽 가상 어플라이언스에 대한 NIC만 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="3d0be-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-170">**GatewaySubnet**.</span></span> <span data-ttu-id="3d0be-171">다른 네트워크와 Azure Vnet 간의 연결을 제공하기 위해 Express 경로 및 VPN 게이트웨이에 필요한 Azure 하이브리드 연결 서브넷입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="3d0be-172">**azurevnet** 네트워크에 있는 3개의 방화벽 가상 어플라이언스</span><span class="sxs-lookup"><span data-stu-id="3d0be-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="3d0be-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-173">**AZF1**.</span></span> <span data-ttu-id="3d0be-174">Azure에서 공용 IP 주소 리소스를 사용하여 공용 인터넷에 노출되는 외부 방화벽입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="3d0be-175">3-NIC 가상 어플라이언스를 프로비전하는 어플라이언스 공급업체에서 직접 또는 마켓플레이스에서 얻은 템플릿이 있는지 확인해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3d0be-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-176">**AZF2**.</span></span> <span data-ttu-id="3d0be-177">**azsn2** 및 **azsn3** 간의 트래픽을 제어하는 데 사용되는 내부 방화벽입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="3d0be-178">또한 3-NIC 가상 어플라이언스입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3d0be-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="3d0be-179">**AZF3**.</span></span> <span data-ttu-id="3d0be-180">온-프레미스 데이터 센터에서 관리자가 액세스할 수 있고 모든 방화벽 어플라이언스를 관리하는 데 사용되는 관리 서브넷에 연결된 관리 방화벽입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="3d0be-181">마켓플레이스에서 2-NIC 가상 어플라이언스 템플릿을 찾거나 어플라이언스 공급업체로부터 직접 요청할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="3d0be-182">UDR(사용자 정의 라우팅)</span><span class="sxs-lookup"><span data-stu-id="3d0be-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="3d0be-183">Azure에서 각 서브넷은 해당 서브넷에서 시작된 트래픽이 라우트되는 방법을 정의하는 데 사용된 UDR 테이블에 연결될 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="3d0be-184">UDR이 정의되지 않은 경우 Azure는 기본 경로를 사용하여 한 서브넷에서 다른 서브넷으로 트래픽 흐름을 허용합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="3d0be-185">UDR에 대한 자세한 내용은 [사용자 정의된 경로 및 IP 전달이란?](virtual-networks-udr-overview.md#ip-forwarding)을 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="3d0be-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3d0be-186">위의 마지막 요구 사항에 따라 적절한 방화벽 어플라이언스를 통해 통신이 수행되려면 **azurevnet**에서 UDR을 포함하는 다음 경로 테이블을 만들어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="3d0be-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="3d0be-187">azgwudr</span></span>
<span data-ttu-id="3d0be-188">이 시나리오에서는 온-프레미스에서 Azure로 흘러가는 트래픽만 **AZF3**에 연결하여 방화벽을 관리하는 데 사용되며 해당 트래픽은 내부 방화벽 **AZF2**를 통해 이동해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="3d0be-189">따라서 아래와 같이 **GatewaySubnet** 에서 단 하나의 경로가 필요합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="3d0be-190">대상</span><span class="sxs-lookup"><span data-stu-id="3d0be-190">Destination</span></span> | <span data-ttu-id="3d0be-191">다음 홉</span><span class="sxs-lookup"><span data-stu-id="3d0be-191">Next hop</span></span> | <span data-ttu-id="3d0be-192">설명</span><span class="sxs-lookup"><span data-stu-id="3d0be-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-193">10.0.4.0/24</span></span> |<span data-ttu-id="3d0be-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="3d0be-194">10.0.3.11</span></span> |<span data-ttu-id="3d0be-195">관리 방화벽 **AZF3**</span><span class="sxs-lookup"><span data-stu-id="3d0be-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="3d0be-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="3d0be-196">azsn2udr</span></span>
| <span data-ttu-id="3d0be-197">대상</span><span class="sxs-lookup"><span data-stu-id="3d0be-197">Destination</span></span> | <span data-ttu-id="3d0be-198">다음 홉</span><span class="sxs-lookup"><span data-stu-id="3d0be-198">Next hop</span></span> | <span data-ttu-id="3d0be-199">설명</span><span class="sxs-lookup"><span data-stu-id="3d0be-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-200">10.0.3.0/24</span></span> |<span data-ttu-id="3d0be-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="3d0be-201">10.0.2.11</span></span> |<span data-ttu-id="3d0be-202">**AZF2**</span><span class="sxs-lookup"><span data-stu-id="3d0be-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="3d0be-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="3d0be-203">0.0.0.0/0</span></span> |<span data-ttu-id="3d0be-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="3d0be-204">10.0.2.10</span></span> |<span data-ttu-id="3d0be-205">**AZF1**</span><span class="sxs-lookup"><span data-stu-id="3d0be-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="3d0be-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="3d0be-206">azsn3udr</span></span>
| <span data-ttu-id="3d0be-207">대상</span><span class="sxs-lookup"><span data-stu-id="3d0be-207">Destination</span></span> | <span data-ttu-id="3d0be-208">다음 홉</span><span class="sxs-lookup"><span data-stu-id="3d0be-208">Next hop</span></span> | <span data-ttu-id="3d0be-209">설명</span><span class="sxs-lookup"><span data-stu-id="3d0be-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-210">10.0.2.0/24</span></span> |<span data-ttu-id="3d0be-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="3d0be-211">10.0.3.10</span></span> |<span data-ttu-id="3d0be-212">**AZF2**를 통해 앱 서버에서 웹 서버로 흐르는 **azsn2**에 대한 트래픽 허용</span><span class="sxs-lookup"><span data-stu-id="3d0be-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="3d0be-213">또한 온-프레미스 데이터 센터를 가장하는 **onpremvnet** 에서 서브넷에 대한 경로 테이블을 만들어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="3d0be-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="3d0be-214">onpremsn1udr</span></span>
| <span data-ttu-id="3d0be-215">대상</span><span class="sxs-lookup"><span data-stu-id="3d0be-215">Destination</span></span> | <span data-ttu-id="3d0be-216">다음 홉</span><span class="sxs-lookup"><span data-stu-id="3d0be-216">Next hop</span></span> | <span data-ttu-id="3d0be-217">설명</span><span class="sxs-lookup"><span data-stu-id="3d0be-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-218">192.168.2.0/24</span></span> |<span data-ttu-id="3d0be-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="3d0be-219">192.168.1.4</span></span> |<span data-ttu-id="3d0be-220">**OPFW**를 통해 **onpremsn2**에 대한 트래픽 허용</span><span class="sxs-lookup"><span data-stu-id="3d0be-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="3d0be-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="3d0be-221">onpremsn2udr</span></span>
| <span data-ttu-id="3d0be-222">대상</span><span class="sxs-lookup"><span data-stu-id="3d0be-222">Destination</span></span> | <span data-ttu-id="3d0be-223">다음 홉</span><span class="sxs-lookup"><span data-stu-id="3d0be-223">Next hop</span></span> | <span data-ttu-id="3d0be-224">설명</span><span class="sxs-lookup"><span data-stu-id="3d0be-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d0be-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-225">10.0.3.0/24</span></span> |<span data-ttu-id="3d0be-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3d0be-226">192.168.2.4</span></span> |<span data-ttu-id="3d0be-227">**onpremsn2**</span><span class="sxs-lookup"><span data-stu-id="3d0be-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="3d0be-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="3d0be-228">192.168.1.0/24</span></span> |<span data-ttu-id="3d0be-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3d0be-229">192.168.2.4</span></span> |<span data-ttu-id="3d0be-230">**OPFW**를 통해 **onpremsn1**에 대한 트래픽 허용</span><span class="sxs-lookup"><span data-stu-id="3d0be-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="3d0be-231">IP 전달</span><span class="sxs-lookup"><span data-stu-id="3d0be-231">IP Forwarding</span></span>
<span data-ttu-id="3d0be-232">UDR 및 IP 전달은 Azure VNet에서 트래픽 흐름을 제어하는 데 사용되는 가상 어플라이언스를 허용하도록 조합하여 사용할 수 있는 기능입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="3d0be-233">가상 어플라이언스는 방화벽이나 NAT 장치와 같이 네트워크 트래픽을 처리하는 데 사용되는 응용 프로그램을 실행하는 VM일 뿐입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="3d0be-234">이 가상 어플라이언스 VM은 주소가 자신으로 지정되지 않은 들어오는 트래픽을 받을 수 있어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="3d0be-235">VM이 다른 대상으로 주소가 지정된 트래픽을 받을 수 있도록 하려면 해당 VM에서 IP 전달을 사용하도록 설정해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="3d0be-236">이것은 Azure 설정으로 게스트 운영 체제에서 설정할 수 없습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="3d0be-237">가상 어플라이언스는 들어오는 트래픽을 처리하고 적절하게 라우트하기 위해 일부 유형의 응용 프로그램을 계속 실행해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="3d0be-238">IP 전달에 대한 자세한 내용은 [사용자 정의된 경로 및 IP 전달이란](virtual-networks-udr-overview.md#ip-forwarding)을 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="3d0be-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3d0be-239">예를 들어 Azure vnet에서 다음과 같이 설정한다고 가정해 봅니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="3d0be-240">서브넷 **onpremsn1**은 **onpremvm1**이라는 VM을 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="3d0be-241">서브넷 **onpremsn2**은 **onpremvm2**이라는 VM을 포함합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="3d0be-242">**OPFW**라는 가상 어플라이언스는 **onpremsn1** 및 **onpremsn2**에 연결되어 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="3d0be-243">**onpremsn1**에 연결된 사용자 정의 경로에는 **onpremsn2**에 대한 모든 트래픽이 **OPFW**로 전송되어야 한다고 지정합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="3d0be-244">이때 **onpremvm1**이 **onpremvm2**와 연결을 설정하려는 경우 UDR이 사용되고 다음 홉으로 트래픽은 **OPFW**에 전송됩니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="3d0be-245">실제 패킷 대상은 변경되지 않고 여전히 **onpremvm2** 가 대상입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="3d0be-246">**OPFW**에 대해 IP 전달을 사용하도록 설정하지 않으면 Azure 가상 네트워크 논리가 패킷을 삭제합니다. 이는 Azure 가상 네트워크가 VM(VM의 IP 주소가 패킷의 대상인 경우)에 보내는 패킷만 허용하기 때문입니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="3d0be-247">IP 전달을 사용하면 Azure 가상 네트워크 논리가 원래 대상 주소를 변경하지 않고 OPFW에 패킷을 전달합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="3d0be-248">**OPFW** 는 패킷을 처리하고 수행할 작업을 결정해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="3d0be-249">위 시나리오가 작동하려면 라우트에 사용되는 **OPFW**, **AZF1**, **AZF2** 및 **AZF3**에 대한 NIC(관리 서브넷에 연결된 NIC를 제외한 모든 NIC)에서 IP 전달을 사용하도록 설정해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="3d0be-250">방화벽 규칙</span><span class="sxs-lookup"><span data-stu-id="3d0be-250">Firewall Rules</span></span>
<span data-ttu-id="3d0be-251">위에서 설명한 대로 IP 전달은 패킷이 가상 어플라이언스에 전송되는지만 확인합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="3d0be-252">어플라이언스는 여전히 해당 패킷으로 수행할 작업을 결정해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="3d0be-253">위의 시나리오에서 어플라이언스에 다음 규칙을 만들어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="3d0be-254">onpremsn2</span><span class="sxs-lookup"><span data-stu-id="3d0be-254">OPFW</span></span>
<span data-ttu-id="3d0be-255">OPFW는 다음 규칙을 포함하는 온-프레미스 장치를 나타냅니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="3d0be-256">**경로**: 10.0.0.0/16(**azurevnet**)에 대한 모든 트래픽을 터널 **ONPREMAZURE**를 통해 전송해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="3d0be-257">**정책**: **포트2** 및 **ONPREMAZURE** 간의 모든 양방향 트래픽을 허용합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="3d0be-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="3d0be-258">AZF1</span></span>
<span data-ttu-id="3d0be-259">AZF1은 다음 규칙을 포함하는 Azure 가상 어플라이언스를 나타냅니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="3d0be-260">**정책**: **port1** 및 **port2** 간의 모든 양방향 트래픽을 허용합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="3d0be-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="3d0be-261">AZF2</span></span>
<span data-ttu-id="3d0be-262">AZF2는 다음 규칙을 포함하는 Azure 가상 어플라이언스를 나타냅니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="3d0be-263">**경로**: 10.0.0.0/16(**onpremvnet**)에 대한 모든 트래픽을 **포트1**을 통해 Azure 게이트웨이 IP 주소(즉, 10.0.0.1)로 전송해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="3d0be-264">**정책**: **port1** 및 **port2** 간의 모든 양방향 트래픽을 허용합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="3d0be-265">NSG(네트워크 보안 그룹)</span><span class="sxs-lookup"><span data-stu-id="3d0be-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="3d0be-266">이 시나리오에서 NSG는 사용되지 않습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="3d0be-267">그러나 들어오고 나가는 트래픽을 제한하기 위해 각 서브넷에 NSG를 적용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="3d0be-268">예를 들어 외부 FW 서브넷에 다음 NSG 규칙을 적용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="3d0be-269">**수신**</span><span class="sxs-lookup"><span data-stu-id="3d0be-269">**Incoming**</span></span>

* <span data-ttu-id="3d0be-270">서브넷의 모든 VM에서 포트 80에 대한 인터넷에서 오는 모든 TCP 트래픽을 허용합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="3d0be-271">인터넷에서 오는 다른 모든 트래픽을 거부합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="3d0be-272">**발신**</span><span class="sxs-lookup"><span data-stu-id="3d0be-272">**Outgoing**</span></span>

* <span data-ttu-id="3d0be-273">인터넷으로 가는 모든 트래픽을 거부합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="3d0be-274">대략적인 단계</span><span class="sxs-lookup"><span data-stu-id="3d0be-274">High level steps</span></span>
<span data-ttu-id="3d0be-275">이 시나리오를 배포하려면 아래 요약된 단계를 수행합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="3d0be-276">Azure 구독에 로그인합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="3d0be-277">온-프레미스 네트워크를 가장하는 VNet을 배포하려는 경우 **ONPREMRG**에 포함된 리소스를 프로비전합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="3d0be-278">**AZURERG**에 포함된 리소스를 프로비전합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="3d0be-279">**onpremvnet**에서 **azurevnet**으로 터널을 프로비전합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="3d0be-280">모든 리소스를 프로비전한 후 **onpremvm2** 로그온하고 10.0.3.101을 ping하여 **onpremsn2**와 **azsn3** 사이의 연결을 테스트합니다.</span><span class="sxs-lookup"><span data-stu-id="3d0be-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

